name: SharePoint ‚Üí Telegram
# Run every 10 minutes + allow manual dispatch
on:
  schedule:
    - cron: '*/10 * * * *'  # Fixed: added missing fields
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4  # Updated to v4
        
      - name: Fetch SP items & notify Telegram
        env:
          AZURE_CLIENT_ID:     ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID:     ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          SITE_ID:             ${{ secrets.SITE_ID }}
          LIST_ID:             ${{ secrets.LIST_ID }}
          BOT_TOKEN:           ${{ secrets.BOT_TOKEN }}
          CHAT_ID:             ${{ secrets.CHAT_ID }}
        run: |
          set -euo pipefail
          echo "üîß Installing Python packages..."
          pip install --user msal requests python-dateutil
          
          echo "üêù Debug BOT_TOKEN=${BOT_TOKEN:0:10}‚Ä¶"
          echo "üêù Debug CHAT_ID=$CHAT_ID"
          echo "üêù Debug SITE_ID=$SITE_ID"
          echo "üêù Debug LIST_ID=$LIST_ID"
          
          python3 - << 'EOF'
          import os, json, time, msal, requests, pathlib
          from dateutil import parser
          
          # ‚Äî AUTH with Azure AD ‚Äî
          app = msal.ConfidentialClientApplication(
              os.environ['AZURE_CLIENT_ID'],
              authority=f"https://login.microsoftonline.com/{os.environ['AZURE_TENANT_ID']}",
              client_credential=os.environ['AZURE_CLIENT_SECRET']
          )
          
          token_resp = app.acquire_token_for_client(["https://graph.microsoft.com/.default"])
          if "access_token" not in token_resp:
              print("‚ùå Azure auth failed:", json.dumps(token_resp, indent=2))
              exit(1)
          
          token = token_resp["access_token"]
          print("‚úÖ Azure authentication successful")
          
          # ‚Äî BUILD Graph URL ‚Äî
          site = os.environ['SITE_ID']
          lst  = os.environ['LIST_ID']
          url = (
              f"https://graph.microsoft.com/v1.0/sites/{site}"
              f"/lists/{lst}/items"
              f"?$expand=fields"
              f"&$orderby=createdDateTime desc"
              f"&$top=50"  # Limit to recent items
          )
          print("‚û°Ô∏è Fetching:", url)
          
          # ‚Äî Use environment variable or default to 1 hour ago ‚Äî
          last_check_env = os.environ.get('LAST_CHECK_TIMESTAMP')
          if last_check_env:
              last = int(last_check_env)
              print(f"üìÖ Using last check from env: {last}")
          else:
              last = int(time.time()) - 3600  # 1 hour ago
              print(f"üìÖ Using default last check (1h ago): {last}")
          
          # ‚Äî FETCH & LOOP ‚Äî
          try:
              resp = requests.get(url, headers={"Authorization": f"Bearer {token}"})
              resp.raise_for_status()
              items = resp.json().get("value", [])
              print(f"üî¢ Received {len(items)} items")
              
              new_last = last
              messages_sent = 0
              
              for idx, itm in enumerate(items, start=1):
                  dt = itm.get("createdDateTime")
                  print(f"üîÑ Processing item #{idx} ‚Äî id={itm.get('id')} createdDateTime={dt}")
                  
                  if not dt:
                      print("   ‚Ü≥ SKIP (no createdDateTime)")
                      continue
                  
                  # Better date parsing
                  try:
                      parsed_dt = parser.parse(dt)
                      ts = int(parsed_dt.timestamp())
                  except Exception as e:
                      print(f"   ‚Ü≥ SKIP (date parse error: {e})")
                      continue
                  
                  print(f"   ‚Ü≥ parsed ts={ts}, last={last}")
                  
                  if ts <= last:
                      print("   ‚Ü≥ BREAK (already processed)")
                      break
                  
                  # Get item details
                  fields = itm.get("fields", {})
                  title = fields.get("Title", "New SharePoint Item")
                  link = itm.get("webUrl", "")
                  
                  # Create message
                  message = f"üìã <b>{title}</b>"
                  if link:
                      message += f"\nüîó <a href='{link}'>View Item</a>"
                  
                  print(f"   ‚Ü≥ SENDING message: {title}")
                  
                  # Send to Telegram
                  try:
                      telegram_resp = requests.post(
                          f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendMessage",
                          json={
                              "chat_id": os.environ['CHAT_ID'],
                              "parse_mode": "HTML",
                              "text": message,
                              "disable_web_page_preview": False
                          },
                          timeout=30
                      )
                      telegram_resp.raise_for_status()
                      messages_sent += 1
                      print(f"   ‚Ü≥ ‚úÖ Message sent successfully")
                  except Exception as e:
                      print(f"   ‚Ü≥ ‚ùå Telegram send failed: {e}")
                      continue
                  
                  new_last = max(new_last, ts)
                  print(f"   ‚Ü≥ new_last updated to {new_last}")
              
              print(f"üéâ Completed! Sent {messages_sent} messages")
              print(f"üíæ Would save new_last: {new_last}")
              
          except requests.exceptions.RequestException as e:
              print(f"‚ùå API request failed: {e}")
              exit(1)
          except Exception as e:
              print(f"‚ùå Unexpected error: {e}")
              exit(1)
          
          EOF
