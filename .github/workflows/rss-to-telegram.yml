name: RSS â†’ Telegram

on:
  schedule:
    - cron: '*/10 * * * *'   # every 10 minutes
  workflow_dispatch:        # manual trigger

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Fetch RSS & notify Telegram
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID:   ${{ secrets.CHAT_ID }}
        RSS_URL:   ${{ secrets.RSS_URL }}
        STATE_FILE: last_rss.json
      run: |
        sudo apt-get update && sudo apt-get install -y python3-feedparser
        python3 - << 'EOF'
import os, json, time, feedparser, requests, pathlib

bot     = os.environ['BOT_TOKEN']
chat    = os.environ['CHAT_ID']
url     = os.environ['RSS_URL']
state_f = pathlib.Path(os.getcwd()) / os.environ['STATE_FILE']

# load last-run timestamp (default: 1 hour ago)
last = int(time.time()) - 3600
if state_f.exists():
  last = json.loads(state_f.read_text()).get('last', last)

feed = feedparser.parse(url)
new_last = last

for e in feed.entries:
  pub = e.get('published_parsed') or e.get('updated_parsed')
  if not pub: continue
  ts = int(time.mktime(pub))
  if ts <= last: continue

  text = f"*{e.title}*\n{e.link}"
  resp = requests.post(
    f"https://api.telegram.org/bot{bot}/sendMessage",
    json={"chat_id":chat, "parse_mode":"Markdown", "text":text}
  )
  resp.raise_for_status()
  new_last = max(new_last, ts)

state_f.write_text(json.dumps({"last":new_last}))
EOF
